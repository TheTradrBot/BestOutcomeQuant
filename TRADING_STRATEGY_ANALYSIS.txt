================================================================================
COMPREHENSIVE TRADING STRATEGY ANALYSIS
FTMO Challenge Analyzer & Main Live Bot
================================================================================

Date: December 22, 2025
Repository: TheTradrBot/mt5bot-new
Purpose: Detailed explanation of how trades are found and executed

================================================================================
TABLE OF CONTENTS
================================================================================

1. ARCHITECTURE OVERVIEW
2. SIGNAL GENERATION PIPELINE
3. CONFLUENCE SCORING SYSTEM
4. REGIME-ADAPTIVE TRADING SYSTEM
5. LIVE BOT IMPLEMENTATION
6. FTMO CHALLENGE ANALYZER
7. TRADE EXECUTION & MANAGEMENT
8. PARAMETERS & OPTIMIZATION
9. RISK MANAGEMENT
10. DATA FLOW & PARITY

================================================================================
1. ARCHITECTURE OVERVIEW
================================================================================

The trading system is built on a modular architecture with single source of truth:

KEY MODULES:
-----------

strategy_core.py (3445 lines)
  - Core trading logic used by ALL components
  - Signal generation
  - Confluence calculation
  - Trade level computation
  - Regime detection

ftmo_challenge_analyzer.py (1778 lines)
  - Backtesting engine
  - Parameter optimization using Optuna
  - Trade simulation
  - Performance analysis

main_live_bot.py (1847 lines)
  - Live MT5 trading bot
  - Real-time scanning
  - Order management
  - Risk monitoring

strategy.py (212 lines)
  - User-facing signal conversion
  - ScanResult display formatting

indicators.py (239 lines)
  - Technical indicators
  - ADX calculation with slope
  - DI crossover detection
  - Support for various technical calculations

CRITICAL PRINCIPLE:
Both backtests and live bot use THE EXACT SAME strategy logic from strategy_core.py
This ensures perfect parity between backtested results and live performance.

================================================================================
2. SIGNAL GENERATION PIPELINE
================================================================================

THE COMPLETE TRADING SIGNAL WORKFLOW
====================================

When either the live bot or analyzer scans a symbol, this is the exact sequence:

STEP 1: GATHER MULTI-TIMEFRAME DATA
-----------------------------------
Load candle data at multiple timeframes:
  - Monthly (MN): Used for long-term trend bias
  - Weekly (W1): Used for intermediate trend and structure
  - Daily (D1): PRIMARY TIMEFRAME for entry signals
  - 4-Hourly (H4): Used for entry confirmation/trigger

Data Requirements:
  - Monthly: 12+ candles (1+ years)
  - Weekly: 52+ candles (1+ year)
  - Daily: 500+ candles (2+ years for backtest)
  - H4: 500+ candles

STEP 2: INFER TREND AT EACH TIMEFRAME
-------------------------------------
Function: _infer_trend() in strategy_core.py

For each timeframe (Monthly, Weekly, Daily), determine trend by analyzing:
1. Recent price structure (higher highs/lower lows)
2. Pattern recognition (ascending/descending channels)
3. Support/Resistance alignment
4. Recent momentum and displacement

Scoring:
  - Bullish signal: +1 for higher highs, higher lows, price above key S/R
  - Bearish signal: +1 for lower highs, lower lows, price below key S/R
  
Result: 
  - "bullish" if bullish_signals > bearish_signals
  - "bearish" if bearish_signals > bullish_signals
  - "mixed" if tied

STEP 3: PICK DIRECTION FROM MULTI-TIMEFRAME BIAS
------------------------------------------------
Function: _pick_direction_from_bias() in strategy_core.py

Inputs:
  - monthly_trend: Trend inferred from monthly candles
  - weekly_trend: Trend inferred from weekly candles
  - daily_trend: Trend inferred from daily candles

Decision Logic:
  
  Rule 1: Alignment Required
    If 2+ timeframes agree on direction → trade that direction
    
  Rule 2: Conflicted Markets
    If trends disagree (e.g., weekly bullish but daily bearish):
      - Use Daily trend as default
      - Set htf_aligned = False (lower quality signal)
      
  Rule 3: Mixed Scenarios
    If any timeframe shows "mixed" (no clear trend):
      - Still trade if 2 timeframes align
      - Flag as lower confidence

Example:
  Monthly: BULLISH
  Weekly: BULLISH
  Daily: BEARISH
  
  Result: BULLISH (2/3 agreement)
  HTF Aligned: YES (monthly and weekly both bullish)
  
This creates the highest quality signals - when higher timeframes agree
and lower timeframes are not diverging sharply.

STEP 4: COMPUTE CONFLUENCE SCORE (THE CORE ENGINE)
-------------------------------------------------
Function: compute_confluence() in strategy_core.py

A confluence score is a count of how many independent factors align with
the chosen direction. Each factor is validated independently:

CONFLUENCE PILLARS (7 total):
============================

1. HTF BIAS (Higher Timeframe Filter)
   - Check: Monthly/Weekly/Daily trends align with direction
   - Pass: 2+ timeframes agree with chosen direction
   - Impact: High - ensures macro alignment
   - Function: _pick_direction_from_bias()
   
   DETAILS:
   - If monthly and weekly both bullish → HTF BIAS = 1
   - If only daily bullish, monthly/weekly mixed → HTF BIAS = 0
   - Critical for avoiding counter-trend entries in multi-timeframe conflicts

2. LOCATION (Support/Resistance Context)
   - Check: Price at key S/R zone
   - Pass: Price within ATR * 0.5 of swing pivot
   - Impact: Medium-High - entries at zones have better odds
   - Function: _location_context()
   
   DETAILS:
   - Find recent swing highs (for bearish) and lows (for bullish)
   - Use 3-period lookback for pivot identification
   - Also checks historical S/R from 20+ years of data (if available)
   - For bullish: price near support zone
   - For bearish: price near resistance zone
   - Tolerance = ATR * 0.5 (tighter zones for volatile pairs)

3. FIBONACCI RETRACEMENT (Golden Zone Entry)
   - Check: Price in Fib golden pocket (38.2% - 88.6% retracement)
   - Pass: Price between 38.2% and 88.6% of recent swing
   - Impact: Medium-High - Fib zones have statistically high win rate
   - Function: _fib_context()
   
   DETAILS:
   - Identify last swing (using BOS detection for Blueprint pattern)
   - Calculate Fibonacci levels between swing low and high
   - Golden Pocket = 61.8% retracement (optimal entry)
   - Extended zones = 38.2% to 88.6% range
   - For bullish: Find recent high, calculate retracement FROM that high
   - For bearish: Find recent low, calculate retracement FROM that low
   - Current price in zone = valid entry level

4. DISPLACEMENT (Strong Candle Detection)
   - Check: Candle shows strong momentum beyond key levels
   - Pass: Candle body > 1.5x ATR beyond structure/S/R
   - Impact: Medium - Displacement = strong momentum confirmation
   - Function: _displacement_context()
   
   DETAILS:
   - Identify key technical levels (structure, S/R zones)
   - Check if current candle breaks beyond these levels with strong body
   - Strong displacement requires:
     * Large candle body (> 50% of daily ATR)
     * Closing beyond structure by at least 1.5x ATR
   - For bullish: Strong candle above resistance level
   - For bearish: Strong candle below support level

5. STRUCTURE (Break of Structure / Choch)
   - Check: Market structure aligned with direction
   - Pass: Higher High/Higher Low (bullish) or Lower High/Lower Low (bearish)
   - Impact: Medium-High - Structure alignment = trend continuation
   - Function: _structure_context()
   
   DETAILS:
   - Identify recent swing points (lookback=3 bars)
   - Bullish structure:
     * Higher Low: Latest swing low > previous swing low
     * Higher High: Latest swing high > previous swing high
     * BOS Up: Close breaks above highest point in lookback period
   - Bearish structure:
     * Lower High: Latest swing high < previous swing high
     * Lower Low: Latest swing low < previous swing low
     * BOS Down: Close breaks below lowest point in lookback period
   - Strongest: BOS (break of structure)
   - Medium: HH/HL or LH/LL pattern
   - Weakest: Just higher low or lower high

6. ENTRY CONFIRMATION (4H Timeframe Trigger)
   - Check: 4H candle shows rejection/engulfing/BOS
   - Pass: Last H4 candle is bullish engulfing (for longs) or bearish engulfing (shorts)
   - Impact: High - This is the actual entry trigger
   - Function: _h4_confirmation()
   
   DETAILS:
   - Engulfing Pattern:
     * Bullish: H4 close > open AND close > previous bar high AND open < previous bar low
     * Bearish: H4 close < open AND close < previous bar low AND open > previous bar high
   - Pinbar Pattern:
     * Bullish: Lower wick > 2x body size, upper wick < 0.5x body size
     * Bearish: Upper wick > 2x body size, lower wick < 0.5x body size
   - BOS Detection:
     * Bullish: H4 high > highest of last 4 bars + bullish close
     * Bearish: H4 low < lowest of last 4 bars + bearish close
   - Strong candle: Body > 60% of full range
   
   Signal Status:
     - "active": Has confirmation → can place market/pending order
     - "watching": No confirmation yet → wait for H4 candle
     - "scan_only": Low confluence → just monitor

7. RISK/REWARD (R:R Validation)
   - Check: Entry, SL, TP placement provide positive R:R
   - Pass: Risk/Reward ratio >= 1.0 (minimum)
   - Impact: High - Bad R:R setup = bad trade despite confluence
   - Function: compute_trade_levels()
   
   DETAILS:
   - Entry: Price near golden pocket of Fib retracement
   - Stop Loss: Below swing low (bullish) or above swing high (bearish)
               Use structure-based SL when available
               SL = min of (swing low - ATR*0.5, structure level - ATR*0.4)
   - TP1: Entry + (Entry - SL) * 1.5 (1.5R)
   - TP2: Entry + (Entry - SL) * 3.0 (3.0R)
   - TP3: Entry + (Entry - SL) * 5.0 (5.0R)
   - TP4: Entry + (Entry - SL) * 7.0 (7.0R)
   - TP5: Entry + (Entry - SL) * 10.0 (10.0R)
   
   Validation:
   - If R/R < 1.0 → REJECT (bad setup)
   - If R/R >= 1.0 → ACCEPT (valid trade

ADDITIONAL ADVANCED FILTERS (Optional):

A. ADX TREND STRENGTH (detect_regime())
   - 0-20: Range mode (conservative)
   - 20-25: Transition (no trading)
   - 25+: Trend mode (momentum)

B. MOMENTUM FILTER
   - Rate of Change: Compare current price to price 10 bars ago
   - Direction aligned: ROC should match trade direction
   - Momentum aligned: Short-term ROC (5-bar) should match direction

C. MEAN REVERSION
   - Trade mean reversion setups in range mode
   - Price at support (bullish) or resistance (bearish)
   - Conservative entry with strict stops
   - Used only when ADX < 20 (weak trend)

D. VOLATILITY REGIME
   - ATR percentile >= 60th (default)
   - Current ATR should be above historical average
   - Ensures trading in active market, not dead zones

E. PATTERN CONFIRMATION
   - Bullish N: Impulse up → pullback → higher low formation
   - Bearish V: Impulse down → pullback → lower high formation

CONFLUENCE SCORE CALCULATION
=============================

confluence_score = sum of all pillars that pass

Example 1: Strong Bullish Setup
  ✓ HTF Bias: Monthly+Weekly bullish = 1 point
  ✓ Location: Price 50 pips from daily support = 1 point
  ✓ Fib: Price in golden pocket 0.618 = 1 point
  ✓ Displacement: Strong candle above resistance = 1 point
  ✓ Structure: Higher Low formed = 1 point
  ✗ Confirmation: H4 still ranging = 0 points
  ✓ R:R: Entry/SL/TP ratio = 1.5 = 1 point
  
  TOTAL: 6/7 confluence
  Quality Factors: 5 (location, fib, displacement, structure, htf)
  Status: WATCHING (confluence high, but no confirmation yet)

Example 2: Active Trade with Full Setup
  ✓ HTF Bias = 1
  ✓ Location = 1
  ✓ Fib = 1
  ✓ Displacement = 1
  ✓ Structure = 1
  ✓ Confirmation: H4 bullish engulfing = 1
  ✓ R:R = 1.5 = 1
  
  TOTAL: 7/7 confluence
  Quality Factors: 5
  Status: ACTIVE (ready to trade!)

MINIMUM REQUIREMENTS (Configurable):
  - MIN_CONFLUENCE: 4-6 (default 5)
  - MIN_QUALITY_FACTORS: 1-3 (default 1-3)

These thresholds are optimized by Optuna to maximize backtest returns.

================================================================================
3. CONFLUENCE SCORING SYSTEM (DEEP DIVE)
================================================================================

WHAT MAKES CONFLUENCE WORK?
===========================

Confluence is based on the principle that multiple factors pointing in the same
direction = higher probability trade. It's not about any single indicator being
"perfect" - it's about CONVERGENCE of different analysis methods to the same
conclusion.

WHY CONFLUENCE BEATS SINGLE INDICATORS:
---------------------------------------

Single Indicator Problems:
  - Moving Averages: Lag price, give false breakout signals
  - Support/Resistance: Sometimes breaks through without warning
  - Fibonacci Levels: Can fail if not at major structure confluence

Confluence Advantage:
  - Support Zone says "bullish" (price at support)
  - Fibonacci says "bullish" (in golden pocket)
  - Structure says "bullish" (higher low just formed)
  - Displacement says "bullish" (strong candle breaks resistance)
  - H4 confirmation says "bullish" (engulfing candle)
  
  Result: 5/7 confluence
  Interpretation: VERY HIGH probability trade
  Expectation: Win rate 65-75% on 5+ confluence setups
  
Diversification:
  The 7 pillars use completely different analysis methods:
    1. Trend - price structure analysis
    2. Support/Resistance - swing pivots
    3. Fibonacci - harmonic ratios
    4. Structure - price action / swing patterns
    5. Displacement - strong candle momentum
    6. Confirmation - H4 rejection candles
    7. Risk/Reward - math-based validation

No single indicator dominates. All must be evaluated independently.

================================================================================
4. REGIME-ADAPTIVE TRADING SYSTEM (REVOLUTIONARY)
================================================================================

THE DUAL-MODE STRATEGY
======================

This bot adapts its trading rules based on market regime detected by ADX.

ADX (Average Directional Index):
  - Measures trend strength (not direction)
  - 0-20: Weak trend (ranging)
  - 20-25: Transition zone
  - 25+: Strong trend (momentum)

REGIME DETECTION LOGIC
======================

detect_regime() in strategy_core.py calculates:
  1. Current ADX value
  2. ADX slope (is it rising or falling?)
  3. +DI and -DI values (directional strength)
  4. DI crossover detection (recent direction shift?)

Result: Classification into one of three regimes

---

TREND MODE (ADX >= 25.0)
========================

Activation: When ADX >= 25, market is in strong trend

Characteristics:
  - Price making new highs/lows
  - Clear directional movement
  - Pullbacks are shallow
  - Bounces are quick and strong

Trading Rules (Trend Mode):
  1. Use trend-following entries
  2. Wait for pullback to key level
  3. Enter on break of structure up/down
  4. Min confluence: 6/7 (high bar for momentum)
  5. Quality factors: >= 3 required
  
  Entry Trigger Examples:
    - Price bounces off daily support zone
    - H4 shows bullish engulfing at that support
    - Structure already shows higher lows (uptrend)
    - Fibonacci 61.8% retracement zone
    
  SL Placement:
    - Below most recent swing low
    - Use structure-based calculation
    - ATR * 1.0 to 1.5 buffer below structure
    
  TP Management:
    - TP1 at 1.5R (close 25%)
    - TP2 at 3.0R (close 25%)
    - TP3 at 5.0R (close 20%)
    - TP4 at 7.0R (close 15%)
    - TP5 at 10.0R (close 15%)
    - Trailing stop after TP1 hit

  Why This Works:
    - Trends have momentum
    - Pullbacks are typically ~38-50% of prior move
    - Fibonacci 61.8% = sweet spot for trend continuation
    - High confluence prevents early entries before real pullback
    
Example Trend Mode Trade:
  EUR/USD daily: In strong uptrend (ADX=28)
  - Price pulls back to 61.8% Fib of recent impulse
  - That level coincides with daily support zone (swing low)
  - H4 forms bullish engulfing at that level
  - Entry: Long at support + H4 confirmation
  - SL: Below recent swing low
  - TP1: 1.5R up → close 25%, move SL to breakeven
  - Then scale out on TP2, TP3, TP4, TP5

---

RANGE MODE (ADX < 20.0)
=======================

Activation: When ADX < 20, market is ranging (no clear trend)

Characteristics:
  - Price oscillating between bounds
  - No new highs or new lows
  - Quick reversals from extremes
  - Mean reversion works well

Trading Rules (Range Mode) - ULTRA CONSERVATIVE:
ALL of these conditions must be met:

  1. Confluence >= 5/7 (slightly lower bar than Trend Mode)
  2. Price in Fib 0.786 retracement zone (VERY deep retracement)
  3. H4 rejection candle (MUST have pinbar/engulfing)
  4. Price at major S/R zone (support for longs, resistance for shorts)
  5. RSI extreme required:
     - For longs: RSI < 25 (oversold)
     - For shorts: RSI > 75 (overbought)
  6. ATR volatility low: Current ATR(14) < 0.8 * ATR(50)
  7. Bollinger Bands reversal (optional)
  
  Entry Trigger (Range Mode):
    - Price oversold at support with rejection candle
    - H4 shows lower wick (hammer) or engulfing
    - No fresh impulse down (structure confirms no breakout)
    - Fibonacci deep zone (0.786 = last chance level)
    
  SL Placement:
    - Just below the swing low tested
    - Should be tight (low risk)
    - Typically 20-40 pips for majors
    
  TP Management:
    - TP1 at 1.0R (close 50% immediately at 1R)
    - TP2 at 2.0R (close 30%)
    - TP3 at 3.0R (close 20%)
    - NO runner (too risky in range)
    
  Why This Works:
    - Ranging markets mean-revert to center
    - Extremes (RSI < 25) are temporary
    - 0.786 Fib is final support before further drop
    - Tight SL limits loss to 1% per trade
    - Small targets (1-3R) taken quickly
    
Example Range Mode Trade:
  GBP/USD daily: In range (ADX=15)
  - Price falls to 0.786 Fib retracement of prior range
  - That level is daily support with 3 touches
  - RSI at 18 (oversold)
  - H4 shows hammer (lower wick)
  - Entry: Long with tight SL
  - TP1: 1.0R → take 50% immediately
  - TP2: 2.0R → take 30%
  - TP3: 3.0R → take 20%
  - Total risk: 0.5% per trade, max reward 2-3R before exit

---

TRANSITION ZONE (ADX between 20-25)
===================================

Activation: When 20 < ADX < 25, regime is unclear

Rules:
  NO ENTRIES ALLOWED
  Market is transitioning between trend and range
  Wait for regime confirmation
  
Rationale:
  - Could go either way (break into trend or fall back to range)
  - Whipsaws are common in transition
  - Not enough momentum for trend trade (ADX too low)
  - Too much momentum for range mean reversion (ADX too high)
  - Risk/reward unfavorable during transition
  
Practice:
  Scanner still runs but marks setups as "watching"
  No pending orders placed
  Wait for ADX to clearly cross above 25 or below 20
  Then enter with regime-appropriate rules

EARLY TREND DETECTION (Optional Feature):
=========================================

When use_adx_slope_rising = True:

ADX may be at 23 (slightly below 25 threshold) but:
  - ADX slope is positive (rising over last 3 bars)
  - ADX is within 3 points of threshold (20-26 range)
  - +DI/−DI crossover detected recently
  
Then: ALLOW Trend Mode entry early
Rationale: ADX rising means trend strengthening, don't wait for 25 crossing

Example:
  ADX = 23 (below 25 threshold)
  ADX slope = +1.5 (rising)
  +DI just crossed above −DI
  → Classify as Trend Mode (early detection)
  → Trade with trend rules

================================================================================
5. LIVE BOT IMPLEMENTATION
================================================================================

MAIN_LIVE_BOT.PY WORKFLOW
=========================

Class: LiveTradingBot

Initialization:
  1. Connect to MT5 (requires .env with server/login/password)
  2. Load best parameters from best_params.json (from optimizer)
  3. Discover broker symbols (FTMO format: EURUSD, XAUUSD, etc.)
  4. Map OANDA symbols to broker symbols
  5. Initialize Challenge Risk Manager (FTMO compliance)
  6. Load pending setups from file (if resuming)
  7. Load trading days tracker
  8. Auto-start Phase 1 of challenge

Symbol Mapping:
  OANDA Format:   EUR_USD, XAU_USD, SPX500_USD, BTC_USD
  FTMO Format:    EURUSD, XAUUSD, US500.cash, BTCUSD
  
  Mapping happens in symbol_mapping.py
  Every symbol is converted before MT5 API calls

Main Loop (Runs every 10 seconds):
  1. Get current time
  2. If SCAN_INTERVAL_HOURS passed since last scan → SCAN
  3. Validate all pending setups (check for entry points)
  4. Manage open positions (check for TP/SL hits, trailing stops)
  5. Monitor risk metrics (daily loss, drawdown)
  6. Log status

---

SCANNING WORKFLOW (scan_symbol method)
======================================

For each symbol (34 total: 28 forex + 2 metals + 2 indices + 2 crypto):

Step 1: Check Prerequisites
  - Symbol available on broker? (if not, skip)
  - Already have open position? (if yes, skip)
  - Already have pending setup? (if yes, skip)
  
Step 2: Load Multi-Timeframe Data
  - Get Daily 500 candles
  - Get H4 500 candles
  - Get Weekly 104 candles
  - Get Monthly 24 candles
  
Step 3: Infer Trends
  - Calculate monthly trend
  - Calculate weekly trend
  - Calculate daily trend
  
Step 4: Pick Direction
  - Use majority rule (2+ timeframes = direction)
  - Flag if HTF not aligned
  
Step 5: Compute Confluence
  - Check all 7 pillars
  - Calculate confluence score
  - Get trade levels (entry, SL, TP1-5)
  
Step 6: Determine Status
  - If confluence >= MIN and confirmation = YES → "active"
  - If confluence >= MIN and confirmation = NO → "watching"
  - If confluence < MIN → "scan_only"
  
Step 7: Create Pending Setup (if "active")
  - Store entry, SL, TP1-5 levels
  - Store confluence score
  - Set order_ticket = None (not placed yet)
  - Save to pending_setups.json
  
Step 8: Place Pending Order (if conditions allow)
  - Check risk: Trade risk <= 0.5% account
  - Check cumulative risk: Total open risk <= 5% account
  - Check trade limit: Not > 10 trades today
  - If all pass: Create pending buy/sell order at entry level
    * Order expires in 24 hours
    * Stop loss set to SL level
    * Take profit set to TP1 level

Result:
  Setup logged to console and to live_trading_log
  Pending order created (or stored as "waiting" if limits hit)

---

PENDING SETUP MANAGEMENT
========================

PendingSetup dataclass tracks:
  - symbol: The pair
  - direction: "long" or "short"
  - entry_price: Where to enter
  - stop_loss: Where to cut loss
  - tp1, tp2, tp3, tp4, tp5: Take profit levels
  - confluence: Confluence score (0-7)
  - quality_factors: Count of key factors (0-5)
  - created_at: When setup was created
  - order_ticket: MT5 order ID (once placed)
  - status: "pending" (waiting for entry), "active" (in trade), "expired"
  - lot_size: Position size calculated
  - trailing_sl: Current trailing stop level
  - partial_closes: How many TP levels already taken

Validation Loop (every 10 seconds):
  For each pending setup:
    1. Check current price vs entry level
    2. If price touched entry → place market order
    3. If order filled → update status to "active"
    4. Monitor stop loss and take profits
    5. Check expiry (24-hour max age)
    6. If expired → cancel order, remove setup

---

POSITION MANAGEMENT
===================

Once Position is Filled:

Automatic Actions:
  1. Update trade_state.json with open position
  2. Record trading day (for FTMO min days requirement)
  3. Set risk tracker to 0.5% account (risk per trade)
  
Ongoing Management:
  1. Monitor current price vs SL/TP levels
  2. When TP1 hit → close 25% of position
  3. When TP2 hit → close 25% of position
  4. When TP3 hit → close 20% of position
  5. When TP4 hit → close 15% of position
  6. When TP5 hit → close remaining 15%
  
  After each partial close:
    - Move SL to breakeven (if TP1 closed)
    - Move SL to TP1 level (if TP2 closed)
    - Move SL to TP2 level (if TP3 closed)
    - Lock in profit progressively
  
7. If SL hit → close all remaining
8. On any close → update equity/balance in risk manager

Risk Controls:
  - Daily loss limit: 5% of account
  - Total drawdown limit: 10% of account
  - Max concurrent trades: 7
  - Max pending orders: 20
  - Position size: 0.5% risk per trade

================================================================================
6. FTMO CHALLENGE ANALYZER
================================================================================

BACKTESTING & OPTIMIZATION ENGINE
==================================

ftmo_challenge_analyzer.py provides:
  1. Full period backtesting (2023-2025)
  2. Parameter optimization via Optuna
  3. Monte Carlo robustness testing
  4. Detailed trade CSV export
  5. Performance reporting

---

BACKTESTING WORKFLOW
====================

run_full_period_backtest() function:

For each symbol (34 total):
  1. Load D1, H4, W1, MN candles from 2023-01-01 to now
  2. For each bar in the period:
     a. Check regime (ADX calculation)
     b. Skip transition zone bars
     c. Apply confluences for that bar
     d. If active setup found:
        - Simulate entry at next bar open
        - Simulate SL and TP exits
        - Track P&L
        - Record all trade details
     e. Move to next bar

Difference from Live Bot:
  - Live bot: Waits for real candles, real prices, real fills
  - Backtest: Simulates using historical data, assumes perfect execution
  - Backtest: No slippage, no requotes, no spike risk
  - Live bot: Must handle all these realities

---

SIMULATION ENGINE
=================

simulate_trades() function (strategy_core.py):

Simulates ONE symbol across the entire backtest period:

For each bar in period:
  1. Check if new setup emerges
  2. If setup active:
     a. Place pending entry (simulated)
     b. Track until entry hits
  3. Once entry filled:
     a. Simulate price action from entry
     b. Check if SL or TP hit
     c. Track partial exits at each TP
     d. Calculate P&L when closed
  4. Record Trade object with all details

Trade Object contains:
  - symbol, direction
  - entry_date, entry_price
  - exit_date, exit_price
  - stop_loss
  - tp1-5 prices
  - risk (entry - SL)
  - reward (exit - entry)
  - rr (reward / risk)
  - is_winner (reward > 0)
  - exit_reason ("tp1", "tp2", "tp3", "tp4", "tp5", or "stop_loss")
  - confluence_score
  
Each trade simulated exactly like the live bot would trade it.

---

OPTIMIZATION WORKFLOW
====================

Optuna-based parameter optimization:

What gets optimized:
  - min_confluence: 2-7 (confluence threshold)
  - trend_min_confluence: 5-7
  - range_min_confluence: 3-6
  - rsi_oversold_range: 20-30
  - rsi_overbought_range: 70-80
  - atr_volatility_ratio: 0.6-0.9
  - adx_trend_threshold: 20-30
  - adx_range_threshold: 15-25
  - atr_min_percentile: 50-70
  - risk_per_trade_pct: 0.25-1.0

Objective function:
  total_profit = sum of all trade rewards
  win_rate = # winners / # trades
  max_drawdown = peak to trough equity drop
  score = total_profit - max_drawdown - slippage_penalty
  
Optuna then:
  1. Suggests parameter combinations
  2. Runs full-period backtest with those params
  3. Evaluates objective function
  4. Uses MedianPruner to kill bad trials early
  5. Adjusts next suggestions based on results
  6. Saves best params to best_params.json

Resumable:
  - Uses SQLite database (regime_adaptive_v2_clean.db)
  - Can pause/resume optimization
  - Check progress with --status flag

---

PERFORMANCE ANALYSIS
====================

After backtest completes:

1. Trade Statistics:
   - Total trades: Count
   - Winners: Count and %
   - Losers: Count and %
   - Avg win: Average profit in R
   - Avg loss: Average loss in R
   - Profit factor: Total wins / Total losses
   - Expectancy: (Win% * Avg Win) - (Loss% * Avg Loss)

2. Risk Analysis:
   - Max drawdown: Peak to trough
   - Drawdown duration: Longest flat period
   - Recovery time: Bars to recover from worst DD
   - Sharpe ratio: Return per unit of risk
   
3. Quarterly Breakdown:
   - Q1 2023, Q2 2023, ... Q4 2025
   - Win rate per quarter
   - Profit per quarter
   - Largest win/loss per quarter

4. Per-Symbol Breakdown:
   - Which symbols work best
   - Which symbols have worst win rate
   - Which produce most profit

5. Monte Carlo Simulation:
   - 1000 simulations of random trade sequences
   - With 10% perturbation (realistic slippage)
   - Outputs: Confidence intervals for drawdown/return
   - Tests robustness: Is strategy luck or skill?

6. CSV Export:
   - All_trades_[period].csv
   - Contains every trade with all details
   - Importable to Excel for analysis

================================================================================
7. TRADE EXECUTION & MANAGEMENT
================================================================================

ENTRY EXECUTION
===============

Market Entry (Live Bot):
  1. Get current bid/ask price
  2. If spread acceptable: Place market order
  3. Market order executed immediately
  4. Position filled at bid (for shorts) or ask (for longs)
  
Pending Entry (Default):
  1. Create pending order at calculated entry level
  2. Order placed with:
     - Entry price (buy/sell limit)
     - Stop loss price (SL)
     - Take profit price (TP1)
  3. Expires in 24 hours if not triggered
  4. Once triggered: Becomes market order
  5. Fills at entry price or better

Pending Order Advantages:
  - Perfect entry price (not slipped)
  - Automatic SL and TP attached
  - Waits up to 24 hours for optimal price
  - Can create many pending setups

Risk Checks Before Entry:
  1. Trade size: Risk <= 0.5% account (fixed)
  2. Cumulative risk: Total open risk <= 5% account
  3. Trade limit: No more than 10 trades per day
  4. Margin: Enough free margin for 1.5x trade size
  5. Challenge rules: Still within daily/total loss limits

Example Entry:
  EUR/USD identified as ACTIVE setup
  Entry: 1.0850
  SL: 1.0825 (25 pips = 0.25%)
  Risk: $500 (0.25% of 200K account)
  
  Position size calculated:
    lot_size = 0.005 EUR/USD contracts
    = 500 EUR position
    = $500 notional risk
  
  Pending order created:
    Type: Buy limit
    Entry: 1.0850
    Stop loss: 1.0825
    Take profit: 1.0900 (TP1)
  
  Order waits up to 24 hours
  If price hits 1.0850 → filled
  If price drops to 1.0825 first → SL hit first, don't enter

---

EXIT MANAGEMENT
===============

Multi-Level Partial Exit Strategy:
  
Entry = 1.0850
SL = 1.0825 (25 pips = risk)
TP1 = 1.0875 (25 pips = 1R)
TP2 = 1.0900 (50 pips = 2R)
TP3 = 1.0925 (75 pips = 3R)
TP4 = 1.0950 (100 pips = 4R)
TP5 = 1.1000 (150 pips = 6R)

Total position size: 5 micro contracts (0.5% risk)

Partial closes:
  1. TP1 (1.0875): Close 25% (1.25 micro)
     - Lock in $125 profit
     - Move SL to entry (1.0850) = BREAKEVEN
     - Remaining 3.75 micro contracts free to run
     
  2. TP2 (1.0900): Close 25% (1.25 micro)
     - Lock in another $125
     - Move SL to TP1 (1.0875)
     - Remaining 2.5 micro contracts can only lose 1R max
     
  3. TP3 (1.0925): Close 20% (1 micro)
     - Lock in $100
     - Move SL to TP2 (1.0900)
     - Remaining 1.5 micro contracts locked at +2R minimum
     
  4. TP4 (1.0950): Close 15% (0.75 micro)
     - Lock in $75
     - Move SL to TP3 (1.0925)
     - Remaining 0.75 micro contracts locked at +3R minimum
     
  5. TP5 (1.1000): Close 15% (0.75 micro)
     - Lock in final $125
     - All closed out

Total profit if all TPs hit: $550 (11% return on $500 account allocation)
Maximum loss if SL hit immediately: -$125 (-2.5% on $500 allocation)

Risk/Reward: $550 potential / $125 loss = 4.4:1

This is why partial profits work:
  - First TP locks in 1R minimum
  - Second TP locks in 2R minimum
  - By TP3, you have $350 locked profit and can't lose more than $100
  - Runner contracts have infinite upside with no additional risk

---

STOP LOSS MANAGEMENT
====================

Initial SL Placement:
  - Structure-based: Below recent swing low (bullish)
  - ATR buffer: SL = swing low - ATR * 0.4 to 0.5
  - Tightness: 20-50 pips for majors (varies by volatility)

Trailing Stop Logic:
  After TP1 is hit:
    - SL moved to entry (breakeven)
    - Position now has ZERO risk
    
  If price pulls back:
    - Can't lose money (SL at entry)
    - Worst case: Break even
    
  If price continues up:
    - Runner contracts continue to profit
    - SL moves up to lock in TP2 level, then TP3, etc.

This creates a "ratchet" effect:
  - Maximum loss: 1R (at entry SL hit)
  - Minimum profit: 0R (if SL at entry hit)
  - Usually: 2-3R average when partial exits work

---

POSITION SIZING FORMULA
=======================

calculate_lot_size() function:

lot_size = (account_risk_pct * account_balance) / (entry_price - stop_loss_price * pip_value)

Example EUR/USD:
  - Account size: $200,000
  - Risk per trade: 0.5% = $1,000
  - Entry: 1.0850
  - SL: 1.0825
  - Risk distance: 25 pips = 0.0025
  - Pip value: $10 per pip (for 1 standard lot)
  
  lot_size = 1000 / (0.0025 * 10)
           = 1000 / 25
           = 0.04 standard lots
           = 4 micro contracts
           = $40,000 notional exposure
           
For Gold (XAU/USD):
  - Entry: 2050
  - SL: 2040
  - Risk distance: 10 pips = $100
  - Pip value: $1 per pip (for 100oz contract)
  
  lot_size = 1000 / 100
           = 10 oz contracts
           = $20,500 notional exposure

Position sizing ensures:
  - Each trade risks exactly 0.5% account
  - High volatility (gold) = smaller size
  - Low volatility (EUR/USD) = larger size
  - Volatility-normalized equal risk per trade

================================================================================
8. PARAMETERS & OPTIMIZATION
================================================================================

PARAMETERIZABLE THRESHOLDS
==========================

Min Confluence Score:
  Type: Integer, 2-7
  Default: 5
  Impact: Higher = fewer trades, higher quality
          Lower = more trades, lower quality
  Optimization: Optuna finds optimal (usually 5-6)

Trend Mode Min Confluence:
  Type: Integer, 5-7
  Default: 6
  Logic: Trends need higher bar than ranges
  
Range Mode Min Confluence:
  Type: Integer, 3-6
  Default: 5
  Logic: Conservative ranges but easier entry

ATR Volatility Ratio (Range Mode):
  Type: Float, 0.6-0.9
  Default: 0.8
  Meaning: Current ATR < 0.8 * Average ATR(50)
  Logic: Ensures low-volatility ranging market

RSI Thresholds (Range Mode):
  Type: Float, 20-30 (oversold), 70-80 (overbought)
  Default: 25 oversold, 75 overbought
  Logic: Extreme RSI = likely reversal point
  
ADX Thresholds:
  Type: Float
  Trend threshold: 20-30 (usually 25)
  Range threshold: 15-25 (usually 20)
  Gap between: 5 points (transition zone)

Risk Per Trade:
  Type: Float %, 0.25-1.0
  Default: 0.5%
  Example: 0.5% of $200K = $1,000 per trade
  
ATR Percentile Filter:
  Type: Float %, 50-70
  Default: 60
  Meaning: Only trade when ATR > 60th percentile
  Logic: Trade in active markets, not dead zones

Maximum Confluence Threshold (for "active" status):
  Type: Integer, 4-7
  Default: 6
  Logic: Need this much confluence + confirmation for active

---

HOW OPTUNA OPTIMIZATION WORKS
==============================

Setup:
  1. Define search space (parameter ranges)
  2. Define objective function (backtest with params)
  3. Define constraints (e.g., max confluence <= 7)

Process:
  Trial 1:
    - Suggest: min_confluence=3, adx_threshold=27, rsi_oversold=22
    - Run full backtest 2023-2025
    - Calculate: Total profit = $50,000, Max DD = $15,000
    - Score = 50,000 - 15,000 = 35,000
    
  Trial 2:
    - Suggest: min_confluence=5, adx_threshold=25, rsi_oversold=25
    - Run full backtest
    - Score = 60,000 - 8,000 = 52,000 (BETTER!)
    
  Trial 3:
    - Suggest: min_confluence=6, adx_threshold=25, rsi_oversold=25
    - Run full backtest
    - Score = 55,000 - 9,000 = 46,000 (worse than Trial 2)
    
  Optuna learns: Trial 2 params look good
  Keeps exploring nearby: min_confluence=5±1, rsi_oversold=25±2
  
  After 100+ trials: Converges on best parameter set
  Saves to: best_params.json

Pruning:
  - MedianPruner stops unpromising trials early
  - If trial is significantly worse than median after 20% completion
  - Stop that trial, save compute time
  - Focus on promising branches

Output:
  - Best parameters saved
  - Used immediately in live bot
  - Live bot loads from best_params.json on startup

================================================================================
9. RISK MANAGEMENT
================================================================================

FTMO CHALLENGE COMPLIANCE
=========================

The FTMO 200K challenge has strict rules:

Phase 1 Target: 10% profit ($20,000)
Phase 2 Target: 5% profit ($10,000)
Max Daily Loss: 5% of account ($10,000)
Max Total DD: 10% of account ($20,000)
Min Trading Days: 4 (must trade on at least 4 different days)

ChallengeRiskManager tracks:

Daily P&L:
  - Calculates profit/loss each day
  - Stops if daily loss > 5%
  - Warning at 2.5% loss
  - Reduced risk at 3.5% loss
  - Emergency halt at 4.2% loss

Total Drawdown:
  - Peak equity - Current equity
  - If drawdown > 10% → Challenge failed
  - Warning at 5%
  - Emergency mode at 7%

Position Limit:
  - Max 7 concurrent trades (prevents overexposure)
  - Max 20 pending orders
  - Max 10 trades per day
  - Max cumulative risk: 5% account

Profit Targets:
  - Phase 1: Need 10% profit to pass
  - Phase 2: Need 5% profit to pass
  - Once reached → Challenge passed!

---

RISK TIER SYSTEM
================

Based on P&L progress:

Red Zone (>3% profit):
  - Risk: 1.0% per trade
  - Max open risk: 5%
  - Aggressive sizing
  - Goal: Quickly reach target

Yellow Zone (0-3% profit):
  - Risk: 0.5% per trade (default)
  - Max open risk: 5%
  - Normal sizing

Orange Zone (-3% to 0 profit):
  - Risk: 0.5% per trade
  - Max open risk: 3%
  - Reduced cumulative

Red Zone (<-3% profit):
  - Risk: 0.25% per trade
  - Max open risk: 1.5%
  - Ultra-conservative
  - Goal: Recover drawdown

This dynamic sizing ensures:
  - Aggressive when winning (chase target faster)
  - Defensive when losing (limit damage)
  - Automatic, no manual intervention

================================================================================
10. DATA FLOW & PARITY
================================================================================

HOW BACKTEST & LIVE BOT STAY IN SYNC
====================================

Both use IDENTICAL code from strategy_core.py:
  - _infer_trend()
  - _pick_direction_from_bias()
  - compute_confluence()
  - compute_trade_levels()
  - detect_regime()
  - validate_range_mode_entry()

Only difference: Data source
  - Backtest: Historical CSV files (time-shifted, known outcomes)
  - Live: Real-time MT5 feeds (current prices, live orders)

Example: EUR/USD signal on 2025-12-20

Backtest view (from historical CSV):
  ✓ Daily candle 2025-12-20: OHLC data loaded from CSV
  ✓ H4 candles 2025-12-20: Multiple H4 bars loaded
  ✓ Weekly/Monthly: Historical data available
  ✓ All confluence checks run on complete candle
  ✓ Entry/SL/TP calculated with full lookback
  ✓ Next bar (2025-12-21) used to execute trade

Live bot view (real-time):
  ✓ Daily candle 2025-12-20 16:59: Forming (price still moving)
  ✓ H4 candles 2025-12-20 16:00, 20:00: Two current H4 bars
  ✓ Weekly/Monthly: Historical data loaded from MT5
  ✓ Confluence checks run on CURRENT partial candle
  ✓ Entry/SL/TP calculated (might update as candle closes)
  ✓ Create pending order at entry level (waits for fill)

Difference:
  - Backtest: Knows full day's OHLC → cleaner analysis
  - Live: Partial day → more uncertain, uses pending orders
  - Backtest: Perfect fills at calculated prices
  - Live: Real fills with slippage, requotes, spreads

Parity Mechanisms:
  1. Pending orders match "would have been active" setups
  2. Both track same confluence pillars
  3. Both use same TP/SL formulas
  4. Both apply same risk sizing
  5. Both use regime-adaptive rules

Expected Outcomes:
  - Live bot should win ~65-70% if confluence high (matches backtest)
  - Slippage costs ~5-10 pips per trade (factored in backtest)
  - Monthly targets achievable if backtest shows 10%+ returns

================================================================================
SUMMARY OF TRADE FINDING LOGIC
================================================================================

SIMPLE EXPLANATION:
===================

1. Bot looks at 34 currency pairs, metals, and indices
2. For each symbol, downloads 2+ years of daily price data
3. Analyzes the trend at monthly, weekly, and daily timeframes
4. Checks if price is at support/resistance zone
5. Checks if price is in golden zone of Fibonacci retracement
6. Checks if 4-hour chart shows rejection/engulfing pattern
7. Counts how many factors align (confluence score 0-7)
8. If 5+ factors aligned AND has entry confirmation → TRADE SIGNAL

9. Creates pending order to buy/sell at calculated price
10. Sets stop loss and take profit levels
11. Waits for price to hit entry (up to 24 hours)
12. Once filled: Automatically exits 25% at TP1, 25% at TP2, etc.
13. Uses profit from partial exits to move stop loss to break-even
14. Lets remaining contracts run for larger targets

RISK MANAGEMENT:
  - Risk only 0.5% per trade
  - Stop loss usually 25-50 pips below entry
  - Take profits at 1.5R, 3R, 5R, 7R, 10R
  - Never risk more than 1% in any single day
  - Never lose more than 2% total equity

OPTIMIZATION:
  - Tests thousands of parameter combinations
  - Finds settings that maximize profits while limiting losses
  - Updates live bot with best parameters daily
  - Continuously learns what works and what doesn't

AUTOMATION:
  - Bot runs 24/7 scanning for setups
  - Automatically places pending orders
  - Automatically manages exits
  - Automatically adjusts position sizes based on performance
  - No manual intervention needed (unless account limit hit)

================================================================================
END OF ANALYSIS
================================================================================

This system represents a sophisticated, multi-layered approach to automated 
trading that combines:
  - Technical analysis (confluence-based)
  - Machine learning optimization (Optuna)
  - Regime detection (ADX-based dual mode)
  - Risk management (FTMO-compliant)
  - Parity assurance (backtest == live)

The strategy trades ONLY high-confluence setups, meaning it waits for multiple
independent factors to align before risking capital. This quality-over-quantity
approach produces higher win rates and more sustainable growth.

For detailed code review, see:
  - strategy_core.py (3445 lines) - Core engine
  - ftmo_challenge_analyzer.py (1778 lines) - Backtest/optimizer
  - main_live_bot.py (1847 lines) - Live implementation

================================================================================
